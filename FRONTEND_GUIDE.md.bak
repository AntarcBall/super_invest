# Stock Prediction & Backtesting Engine

## Overview

A complete machine learning pipeline for stock price prediction with:
- Transfer learning from 91 major stocks
- Advanced feature engineering (ACF/CCF analysis)
- Backtesting simulation
- Real-time model insights
- GPU-accelerated pretraining (RTX 3090)

## System Architecture

```
┌───────────────────────────────────────────────────┐
│  Training Phase (One-time)                              │
│   91 major stocks (2019-2024)                     │
│   → LSTM Model → 128-dim Embeddings            │
└───────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│  Inference Phase (Backtest)                         │
│   Target Stock Data → Feature Engineering              │
│   → Extract Pretrained Embeddings                  │
│   → LightGBM → Predictions                         │
│   → Backtesting Simulation                          │
└───────────────────────────────────────────────────────┘
```

## Quick Start

### Option 1: With Pretrained Model (Recommended)

1. **Train pretrained model** (2-4 hours, one-time):
   ```bash
   bash run_pretrain.sh
   ```

2. **Start frontend**:
   ```bash
   bash run_app.sh
   ```

3. **Enable embeddings**: Check "Use Pretrained Market Embeddings" in sidebar
4. **Run backtest**: Click "Run Backtest" button
5. **View results**: Check "Model Insights" tab to see feature importance including pretrained embeddings

### Option 2: Without Pretrained Model (Baseline)

1. **Start frontend**:
   ```bash
   bash run_app.sh
   ```

2. **Leave embeddings unchecked** in sidebar
3. **Run backtest**: Click "Run Backtest" button
4. **Compare results**: Run both versions and compare Sharpe ratios

## Features

### Fundamental Features
- Market Cap, P/E ratios, Price-to-Book, Dividend Yield

### Technical Features  
- RSI, MACD, Bollinger Bands, SMA (50, 200)
- ATR (Average True Range) - Volatility indicator

### Volatility Features
- VIX (Market Fear Index) - Overall market volatility
- ATR - Stock-specific volatility

### Macroeconomic Features
- Interest rates from FED (Federal Reserve)
- Captures monetary policy impact

### Advanced Features (ACF/CCF)
- **Autocorrelation Analysis (ACF)**: Identifies temporal patterns, trend strength, significant lags
- **Cross-Correlation Analysis (CCF)**: Finds optimal lags for each feature
- **Smart Lag Features**: Data-driven lag selection based on statistical significance
- **Visualizations**: ACF/CCF plots for exploration and analysis

### Pretrained Market Embeddings
- 128-dimensional vectors from LSTM trained on 91 major stocks
- Captures cross-stock patterns learned from 2019-2024 data
- Sectors: Tech, Finance, Healthcare, Energy, Consumer, Industrial
- Transfers general market wisdom to any target stock
- No retraining needed - extracts embeddings instantly
- **No retraining needed**: Extracts embeddings instantly

## Model Architecture

### LSTM (Pretraining)
- **Input**: 50+ features per sequence
- **Hidden Dimension**: 256
- **Layers**: 2 LSTM layers with dropout (0.3)
- **Output**: 128-dimensional embeddings
- **Optimizer**: Adam (lr=0.001)
- **Batch Size**: 256 (GPU-optimized for RTX 3090)
- **Epochs**: 50 with early stopping
- **Loss**: Cross-entropy with class weighting

### LightGBM (Classification)
- **Task**: Binary classification (Buy/Sell signal)
- **Inputs**: All features + 128 pretrained embeddings
- **Advantages**: Fast training, handles mixed data, explainable
- **Output**: Probability of upward movement
- **Hybrid**: Combines pretrained LSTM embeddings with traditional features

## Backtesting

- **Event-driven simulation** with entry/exit signals
- **Starting Capital**: $100,000
- **Strategy**: Buy when model predicts up move, sell when predicts down
- **Metrics**: Sharpe ratio, max drawdown, total return
- **Benchmark**: Buy & hold strategy for comparison

## Performance Comparison

| Metric | Without Pretrained | With Pretrained |
|---------|------------------|------------------|
| Cross-Stock Knowledge | None | From 91 stocks |
| Generalization | Limited | Improved |
| Expected Sharpe Improvement | Baseline | +5-15% |
| Small Stock Performance | Poor | Better |

## Files

### Core Application
- `backtest_app.py` - Streamlit GUI
- `run_app.sh` - cuDNN-compatible startup
- `pretrain_model.py` - Pretraining script (runs in background via tmux)
- `src/data/data_loader.py` - Fetch stock data
- `src/features/feature_builder.py` - Build all features
- `src/features/acf_ccf_analysis.py` - Statistical analysis
- `src/models/prepare_data.py` - Prepare training data
- `src/models/train_model.py` - Train LightGBM
- `src/models/pretrained_utils.py` - Load pretrained model, extract embeddings
- `src/backtesting/engine.py` - Backtesting simulation
- `src/backtesting/metrics.py` - Performance calculations

### Configuration
- `src/config/pretrain_config.py` - 91 stocks, training parameters
- `PRETRAINING_README.md` - Pretraining documentation
- `FRONTEND_GUIDE.md` - Frontend usage guide

### Saved Models
- `models/pretrained_lstm.pth` - Best model weights
- `models/checkpoints/` - Epoch checkpoints (every 5 epochs)
- `models/pretrained_config.json` - Training metadata

## Hardware

- **GPU**: NVIDIA GeForce RTX 3090 (24GB VRAM)
- **CUDA Version**: 12.6
- **Driver Version**: 560.94
- **Optimized For**: Large-scale multi-stock training

## Usage

### Development
```bash
# Train or continue pretraining (background)
bash run_pretrain.sh

# Start frontend with cuDNN fix
bash run_app.sh
```

### Production
```bash
# Ensure pretraining is complete first
ls models/pretrained_lstm.pth

# Start app
bash run_app.sh
```

## Troubleshooting

### Model Not Found?
```bash
# Check if model exists
ls models/pretrained_lstm.pth
```

### Index Errors?
If you see "index out of bounds" errors in backtest, ensure:
1. Pretraining completed successfully
2. Model file exists in `models/` directory
3. Frontend "Use Pretrained Market Embeddings" checkbox is checked

### Performance Not Improving?
1. Try different prediction horizons (sidebar slider: 1-30 days)
2. Adjust buy signal threshold (sidebar slider: 1-10%)
3. Check Feature Analysis tab for insights
4. Compare with/without pretrained embeddings

## Advantages of Transfer Learning

1. **General Market Knowledge**: Learns from 91 major stocks across all sectors
2. **Better Small Stock Performance**: Helps stocks with limited historical data
3. **No Retraining Needed**: Extracts embeddings instantly without model training
4. **Faster Development**: Focus on feature engineering, not model architecture
5. **Sector Awareness**: Captures sector rotation patterns
6. **Cross-Stock Correlations**: Learns relationships between stocks
7. **Scalable**: GPU-accelerated for large-scale training

## Next Steps

1. ✅ **Pretraining**: Run `bash run_pretrain.sh` (2-4 hours)
2. ✅ **Inference**: Run `bash run_app.sh` and enable embeddings
3. ✅ **Analysis**: Explore Feature Analysis tab for insights
4. ✅ **Optimization**: Add suggested lag features from CCF analysis
5. ✅ **Comparison**: Benchmark with/without pretrained model

## Technical Notes

- **cuDNN Fix**: `run_app.sh` unsets `LD_LIBRARY_PATH` to ensure PyTorch uses compatible libraries
- **Memory Efficiency**: Pretrained model uses only ~850K parameters
- **Batch Processing**: Embeddings extracted in batches for efficiency
- **Index Alignment**: Automatically handles sequence-based index shifts
- **Error Handling**: Graceful degradation to standard features if embeddings fail
- **Model Caching**: Frontend caches loaded models for performance

## License

MIT License - Use freely for personal and commercial purposes
